<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>霓光签 | 数字御神签</title>
    <link rel="stylesheet" href="css/globals.css">
    <!-- Three.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <!-- Tone.js音频库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- GSAP动画库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #050510;
            color: #ffffff;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden;
        }

        /* 基本容器 */
        .container {
            position: relative;
            width: 100%;
            height: 100vh;
        }

        /* 导航 */
        nav {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 1000;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInNav 0.8s ease-out forwards 0.5s;
        }

        .nav-decoration {
            position: absolute;
            top: -10px;
            right: -10px;
            width: calc(100% + 20px);
            height: calc(100% + 20px);
            border: 1px solid rgba(148, 0, 255, 0.3);
            z-index: -1;
            opacity: 0;
            animation: decorationFadeIn 1s forwards 0.7s;
        }

        @keyframes fadeInNav {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes decorationFadeIn {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 0.7; transform: scale(1); }
        }

        nav a {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 14px;
            letter-spacing: 2px;
            text-transform: uppercase;
            transition: color 0.3s ease;
            position: relative;
        }

        nav a::before {
            content: attr(data-text);
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 10px;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        nav a:hover {
            color: #9900ff;
        }

        nav a:hover::before {
            opacity: 1;
        }

        .interface-elements {
            position: absolute;
            top: 0;
            right: 100%;
            width: 200px;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            animation: fadeInInterface 1s forwards 1s;
        }

        .interface-line {
            position: absolute;
            height: 1px;
            background: rgba(148, 0, 255, 0.5);
            right: 0;
            top: 50%;
            width: 80px;
            transform: scaleX(0);
            transform-origin: right center;
            animation: lineExtend 0.5s forwards 1.2s;
        }

        .interface-circle {
            position: absolute;
            border: 1px solid rgba(148, 0, 255, 0.5);
            border-radius: 50%;
        }

        @keyframes fadeInInterface {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes lineExtend {
            0% { transform: scaleX(0); }
            100% { transform: scaleX(1); }
        }

        /* 视觉效果层 */
        .noise {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N3d3dtbW17e3t1dXWBgYGHh4d5eXlzc3OLi4ubm5uVlZWPj4+NjY19fX2JiYl/f39ra2uRkZGZmZlpaWmXl5dvb29xcXGTk5NnZ2c8TV1mAAAAG3RSTlNAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAvEOwtAAAFVklEQVR4XpWWB67c2BUFb3g557T/hRo9/WUMZHlgr4Bg8Z4qQgQJlHI4A8SzFVrapvmTF9O7dmYRFZ60YiBhJRCgh1FYhiLAmdvX0CzTOpNE77ME0Zty/nWWzchDtiqrmQDeuv3powQ5ta2eN0FY0InkqDD73lT9c9lEzwUNqgFHs9VQce3TVClFCQrSTfOiYkVJQBmpbq2L6iZavPnAPcoU0dSw0SUTqz/GtrGuXfbyyBniKykOWQWGqwwMA7QiYAxi+IlPdqo+hYHnUt5ZPfnsHJyNiDtnpJyayNBkF6cWoYGAMY92U2hXHF/C1M8uP/ZtYdiuj26UdAdQQSXQErwSOMzt/XWRWAz5GuSBIkwG1H3FabJ2OsUOUhGC6tK4EMtJO0ttC6IBD3kM0ve0tJwMdSfjZo+EEISaeTr9P3wYrGjXqyC1krcKdhMpxEnt5JetoulscpyzhXN5FRpuPHvbeQaKxFAEB6EN+cYN6xD7RYGpXpNndMmZgM5Dcs3YSNFDHUo2LGfZuukSWyUYirJAdYbF3MfqEKmjM+I2EfhA94iG3L7uKrR+GdWD73ydlIB+6hgref1QTlmgmbM3/LeX5GI1Ux1RWpgxpLuZ2+I+IjzZ8wqE4nilvQdkUdfhzI5QDWy+kw5Wgg2pGpeEVeCCA7b85BO3F9DzxB3cdqvBzWcmzbyMiqhzuYqtHRVG2y4x+KOlnyqla8AoWWpuBoYRxzXrfKuILl6SfiWCbjxoZJUaCBj1CjH7GIaDbc9kqBY3W/Rgjda1iqQcOJu2WW+76pZC9QG7M00dffe9hNnseupFL53r8F7YHSwJWUKP2q+k7RdsxyOB11n0xtOvnW4irMMFNV4H0uqwS5ExsmP9AxbDTc9JwgneAT5vTiUSm1E7BSflSt3bfa1tv8Di3R8n3Af7MNWzs49hmauE2wP+ttrq+AsWpFG2awvsuOqbipWHgtuvuaAE+A1Z/7gC9hesnr+7wqCwG8c5yAg3AL1fm8T9AZtp/bbJGwl1pNrE7RuOX7PeMRUERVaPpEs+yqeoSmuOlokqw49pgomjLeh7icHNlG19yjs6XXOMedYm5xH2YxpV2tc0Ro2jJfxC50ApuxGob7lMsxfTbeUv07TyYxpeLucEH1gNd4IKH2LAg5TdVhlCafZvpskfncCfx8pOhJzd76bJWeYFnFciwcYfubRc12Ip/ppIhA1/mSZ/RxjFDrJC5xifFjJpY2Xl5zXdguFqYyTR1zSp1Y9p+tktDYYSNflcxI0iyO4TPBdlRcpeqjK/piF5bklq77VSEaA+z8qmJTFzIWiitbnzR794USKBUaT0NTEsVjZqLaFVqJoPN9ODG70IPbfBHKK+/q/AWR0tJzYHRULOa4MP+W/HfGadZUbfw177G7j/OGbIs8TahLyynl4X4RinF793Oz+BU0saXtUHrVBFT/DnA3ctNPoGbs4hRIjTok8i+algT1lTHi4SxFvONKNrgQFAq2/gFnWMXgwffgYMJpiKYkmW3tTg3ZQ9Jq+f8XN+A5eeUKHWvJWJ2sgJ1Sop+wwhqFVijqWaJhwtD8MNlSBeWNNWTa5Z5kPZw5+LbVT99wqTdx29lMUH4OIG/D86ruKEauBjvH5xy6um/Sfj7ei6UUVk4AIl3MyD4MSSTOFgSwsH/QJWaQ5as7ZcmgBZkzjjU1UrQ74ci1gWBCSGHtuV1H2mhSnO3Wp/3fEV5a+4wz//6qy8JxjZsmxxy5+4w9CDNJY09T072iKG0EnOS0arEYgXqYnXcYHwjTtUNAcMelOd4xpkoqiTYICWFq0JSiPfPDQdnt+4/wuqcXY47QILbgAAAABJRU5ErkJggg==');
            opacity: 0.06;
            mix-blend-mode: overlay;
            pointer-events: none;
            z-index: 5;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
            opacity: 0.05;
            mix-blend-mode: screen;
            background: 
                radial-gradient(circle at 20% 30%, rgba(148, 0, 255, 0.3), transparent 70%),
                radial-gradient(circle at 80% 70%, rgba(0, 183, 255, 0.3), transparent 70%);
        }

        /* 星星效果 */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .star {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            animation: twinkle linear infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.1; }
            50% { opacity: 0.5; }
        }
        
        /* Three.js容器 */
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        
        /* 网站标题 */
        .site-title {
            position: absolute;
            text-align: center;
            width: 100%;
            top: 15%;
            z-index: 100;
            opacity: 0;
            animation: fadeIn 2s ease-out forwards 1s;
        }

        .main-title {
            font-size: 5vw;
            line-height: 1;
            margin: 0;
            font-weight: 300;
            color: #fff;
            text-shadow: 0 0 10px rgba(148, 0, 255, 0.8), 0 0 20px rgba(0, 183, 255, 0.6);
        }

        .subtitle {
            font-size: 1.2vw;
            color: rgba(255,255,255,0.7);
            margin-top: 20px;
            letter-spacing: 0.5em;
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        /* 输入区域 */
        .input-area {
            position: absolute;
            left: 0;
            right: 0;
            top: 60%;
            margin: auto;
            width: 80%;
            max-width: 600px;
            z-index: 100;
            text-align: center;
            opacity: 0;
            animation: fadeIn 2s ease-out forwards 1.5s;
        }
        
        .input-field {
            width: 100%;
            padding: 16px 20px;
            margin: 20px auto;
            background: rgba(18, 16, 22, 0.5);
            border: 1px solid rgba(148, 0, 255, 0.3);
            border-radius: 4px;
            color: #fff;
            font-size: 1.2rem;
            box-shadow: 0 0 20px rgba(148, 0, 255, 0.2);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .input-field:focus {
            outline: none;
            border-color: rgba(148, 0, 255, 0.8);
            box-shadow: 0 0 30px rgba(148, 0, 255, 0.4), 0 0 50px rgba(0, 183, 255, 0.1);
        }
        
        .draw-button {
            display: inline-block;
            padding: 14px 40px;
            margin-top: 20px;
            background: transparent;
            color: #fff;
            font-size: 1.2rem;
            font-weight: 300;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.5s ease;
        }
        
        .draw-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(148, 0, 255, 0.5), rgba(0, 183, 255, 0.5));
            z-index: -1;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.6s ease;
        }
        
        .draw-button:hover {
            border-color: rgba(148, 0, 255, 0.8);
            box-shadow: 0 0 20px rgba(148, 0, 255, 0.3), 0 0 40px rgba(0, 183, 255, 0.1);
        }
        
        .draw-button:hover::before {
            transform: scaleX(1);
        }
        
        /* 结果区域 */
        .result-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 90;
            display: none;
        }
        
        /* 控制按钮 */
        .control-buttons {
            position: absolute;
            right: 30px;
            bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 120;
        }
        
        .control-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(18, 16, 22, 0.6);
            border: 1px solid rgba(148, 0, 255, 0.3);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(148, 0, 255, 0.2);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .control-button:hover {
            border-color: rgba(148, 0, 255, 0.8);
            box-shadow: 0 0 20px rgba(148, 0, 255, 0.4), 0 0 30px rgba(0, 183, 255, 0.1);
        }
        
        /* 加载动画 */
        .loading {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 110;
            display: none;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: rgba(148, 0, 255, 0.8);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 历史记录区 */
        .history-panel {
            position: absolute;
            left: 30px;
            bottom: 30px;
            z-index: 110;
        }
        
        .history-toggle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(18, 16, 22, 0.6);
            border: 1px solid rgba(148, 0, 255, 0.3);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(148, 0, 255, 0.2);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .history-toggle:hover {
            border-color: rgba(148, 0, 255, 0.8);
            box-shadow: 0 0 20px rgba(148, 0, 255, 0.4), 0 0 30px rgba(0, 183, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="noise"></div>
        <div class="overlay"></div>
        <div class="stars" id="stars"></div>
        
        <!-- Three.js画布容器 -->
        <div id="canvas-container"></div>
        
        <!-- 导航栏 -->
        <nav>
            <div class="nav-links">
                <div class="nav-decoration"></div>
                <a href="index.html" data-text="01">HOME</a>
                <a href="about.html" data-text="02">ABOUT</a>
                <a href="new-projects.html" data-text="03">PROJECTS</a>
                <a href="current-assignment.html" data-text="04">ASSIGNMENT #2</a>
                <a href="assignment3.html" data-text="05">ASSIGNMENT #3</a>
                <a href="assignment4.html" data-text="06">ASSIGNMENT #4</a>
                <a href="assignment5.html" data-text="07">ASSIGNMENT #5</a>
                <a href="final-choice.html" data-text="08">FINAL</a>
            </div>
            <div class="interface-elements">
                <div class="interface-line interface-line-1"></div>
                <div class="interface-circle" style="top: 30%; right: 20px; width: 30px; height: 30px;"></div>
                <div class="interface-circle" style="top: 40%; right: 40px; width: 20px; height: 20px;"></div>
            </div>
        </nav>
        
        <!-- 标题部分 -->
        <div class="site-title">
            <h1 class="main-title">霓光签</h1>
            <div class="subtitle">Modern Digital Shrine Divination</div>
        </div>
        
        <!-- 输入区域 -->
        <div class="input-area" id="input-area">
            <input type="text" class="input-field" id="wish-input" placeholder="Enter your spell of heart..." autofocus>
            <button class="draw-button" id="draw-button">DRAW</button>
        </div>
        
        <!-- 结果区域 -->
        <div class="result-area" id="result-area"></div>
        
        <!-- 加载动画 -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
        </div>
        
        <!-- 控制按钮 -->
        <div class="control-buttons" id="control-buttons">
            <div class="control-button" id="save-button" title="Save your divination">💾</div>
            <div class="control-button" id="redraw-button" title="Draw again">🔄</div>
        </div>
        
        <!-- 历史记录 -->
        <div class="history-panel">
            <div class="history-toggle" id="history-toggle" title="View history">📜</div>
        </div>
    </div>
    <script>
        // 创建星星背景
        document.addEventListener('DOMContentLoaded', function() {
            // 创建星星背景
            createStarsBackground();
            
            // 初始化Three.js场景
            initThreeScene();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 加载html2canvas
            loadHtml2Canvas();
        });
        
        function createStarsBackground() {
            const starsContainer = document.getElementById('stars');
            
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // 随机大小
                const size = Math.random() * 2 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                
                // 随机位置
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                
                // 随机闪烁速度
                const duration = Math.random() * 3 + 2;
                star.style.animationDuration = duration + 's';
                
                // 随机延迟
                star.style.animationDelay = Math.random() * 5 + 's';
                
                starsContainer.appendChild(star);
            }
        }
        
        // Three.js全局变量
        let scene, camera, renderer, controls;
        let inkBlob, particles = [];
        let mixer, clock;
        let isDrawing = false;
        let particleSystem;
        
        // 初始化Three.js场景
        function initThreeScene() {
            // 创建场景
            scene = new THREE.Scene();
            
            // 创建相机
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;
            
            // 创建渲染器
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0x000000, 0);
            
            // 添加到DOM
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // 创建轨道控制器
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableRotate = false;
            controls.enablePan = false;
            controls.enableZoom = true;
            controls.minDistance = 3;
            controls.maxDistance = 10;
            
            // 添加光源
            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);
            
            const pointLight = new THREE.PointLight(0x9500ff, 2, 100);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);
            
            const bluePointLight = new THREE.PointLight(0x00b7ff, 2, 100);
            bluePointLight.position.set(-5, -5, 5);
            scene.add(bluePointLight);
            
            // 创建初始墨迹
            createInitialInkBlob();
            
            // 创建时钟
            clock = new THREE.Clock();
            
            // 开始动画循环
            animate();
            
            // 窗口大小改变事件
            window.addEventListener('resize', onWindowResize);
        }
        
        // 创建初始墨迹
        function createInitialInkBlob() {
            // 创建一个墨迹形状的几何体
            const geometry = new THREE.SphereGeometry(1, 32, 32);
            
            // 创建自定义着色器材质
            const material = new THREE.ShaderMaterial({
                uniforms: {
                    time: { value: 0 },
                    color1: { value: new THREE.Color(0x9500ff) },
                    color2: { value: new THREE.Color(0x00b7ff) }
                },
                vertexShader: `
                    uniform float time;
                    
                    varying vec2 vUv;
                    varying vec3 vPosition;
                    varying vec3 vNormal;
                    
                    // 简单的柏林噪声近似
                    float noise(vec3 p) {
                        return fract(sin(dot(p, vec3(12.9898, 78.233, 45.5432))) * 43758.5453);
                    }
                    
                    void main() {
                        vUv = uv;
                        vPosition = position;
                        vNormal = normal;
                        
                        // 添加一些基于时间的波动
                        float noiseVal = noise(vec3(position.xy * 0.5, time * 0.1));
                        vec3 newPosition = position + normal * sin(time + position.y * 2.0) * 0.05;
                        newPosition += normal * noiseVal * 0.1;
                        
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform vec3 color1;
                    uniform vec3 color2;
                    uniform float time;
                    
                    varying vec2 vUv;
                    varying vec3 vPosition;
                    varying vec3 vNormal;
                    
                    void main() {
                        // 根据位置和法线混合两种颜色
                        vec3 color = mix(color1, color2, sin(vUv.y * 3.14159 + time) * 0.5 + 0.5);
                        
                        // 添加发光效果
                        float glow = pow(1.0 - dot(vNormal, vec3(0.0, 0.0, 1.0)), 2.0);
                        color += color * glow * 2.0;
                        
                        // 添加霓虹发光边缘
                        float edge = pow(1.0 - abs(dot(vNormal, vec3(0.0, 0.0, 1.0))), 4.0);
                        color += mix(color1, color2, sin(time * 0.5) * 0.5 + 0.5) * edge * 3.0;
                        
                        gl_FragColor = vec4(color, 0.9);
                    }
                `,
                transparent: true,
                side: THREE.DoubleSide
            });
            
            // 创建墨迹网格
            inkBlob = new THREE.Mesh(geometry, material);
            scene.add(inkBlob);
            
            // 添加缓慢旋转动画
            gsap.to(inkBlob.rotation, {
                x: Math.PI * 2,
                y: Math.PI * 2,
                duration: 30,
                repeat: -1,
                ease: "none"
            });
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 抽签按钮点击事件
            document.getElementById('draw-button').addEventListener('click', startDrawing);
            
            // 重新抽签按钮点击事件
            document.getElementById('redraw-button').addEventListener('click', resetScene);
            
            // 保存按钮点击事件
            document.getElementById('save-button').addEventListener('click', saveFortune);
            
            // 历史记录按钮点击事件
            document.getElementById('history-toggle').addEventListener('click', toggleHistory);
        }
        
        // 窗口大小改变处理
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            
            // 更新墨迹着色器时间
            if (inkBlob && inkBlob.material.uniforms) {
                inkBlob.material.uniforms.time.value = clock.getElapsedTime();
            }
            
            // 更新粒子系统
            if (isDrawing && particles.length > 0) {
                updateParticles();
            }
            
            // 更新混合器
            if (mixer) {
                mixer.update(clock.getDelta());
            }
            
            // 渲染场景
            renderer.render(scene, camera);
        }
        
        // 基本函数定义（后续会实现）
        function startDrawing() {
            console.log("Starting divination...");
            
            // 获取用户输入的咒语
            const wishText = document.getElementById('wish-input').value.trim();
            
            if (!wishText) {
                alert('Please enter your spell of heart');
                return;
            }
            
            // 显示加载动画
            document.getElementById('loading').style.display = 'flex';
            
            // 隐藏输入区域
            document.getElementById('input-area').style.display = 'none';
            
            // 播放开始音效
            playStartSound();
            
            // 开始墨迹爆炸动画
            explodeInkBlob(wishText);
        }
        
        // 墨迹爆炸效果
        function explodeInkBlob(wishText) {
            isDrawing = true;
            
            // 创建粒子系统
            createParticleSystem();
            
            // 隐藏原始墨迹
            gsap.to(inkBlob.material, {
                opacity: 0,
                duration: 1.5,
                ease: "power2.inOut"
            });
            
            // 同时获取API数据
            Promise.all([
                fetchAdvice(),
                fetchAffirmation(),
                fetchPoetry()
            ]).then(results => {
                const [advice, affirmation, poetry] = results;
                
                // 根据用户输入和API结果生成签条
                generateFortune(wishText, advice, affirmation, poetry);
            }).catch(error => {
                console.error('Failed to fetch data:', error);
                // 出错时显示默认签条
                generateFortune(wishText, 
                    'Follow the guidance of your heart, and you will find the true direction.', 
                    'You have infinite potential, believe in yourself to create miracles.', 
                    'Hope is the thing with feathers - That perches in the soul - Emily Dickinson');
            });
        }
        
        // 创建粒子系统
        function createParticleSystem() {
            // 创建粒子几何体
            const particlesGeometry = new THREE.BufferGeometry();
            const particleCount = 2000;
            
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            
            const color1 = new THREE.Color(0x9500ff);
            const color2 = new THREE.Color(0x00b7ff);
            
            for (let i = 0; i < particleCount; i++) {
                const i3 = i * 3;
                
                // 初始位置（从墨迹球体表面开始）
                const phi = Math.acos(-1 + (2 * i) / particleCount);
                const theta = Math.sqrt(particleCount * Math.PI) * phi;
                
                positions[i3] = Math.cos(theta) * Math.sin(phi);
                positions[i3 + 1] = Math.sin(theta) * Math.sin(phi);
                positions[i3 + 2] = Math.cos(phi);
                
                // 随机颜色
                const mixedColor = color1.clone();
                mixedColor.lerp(color2, Math.random());
                
                colors[i3] = mixedColor.r;
                colors[i3 + 1] = mixedColor.g;
                colors[i3 + 2] = mixedColor.b;
            }
            
            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particlesGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            
            // 粒子材质
            const particlesMaterial = new THREE.PointsMaterial({
                size: 0.05,
                sizeAttenuation: true,
                depthWrite: false,
                blending: THREE.AdditiveBlending,
                vertexColors: true,
                transparent: true
            });
            
            // 创建粒子系统
            particleSystem = new THREE.Points(particlesGeometry, particlesMaterial);
            scene.add(particleSystem);
            
            // 粒子爆炸动画
            const positions_array = particlesGeometry.attributes.position.array;
            
            for (let i = 0; i < particleCount; i++) {
                const i3 = i * 3;
                
                // 原始位置
                const x = positions_array[i3];
                const y = positions_array[i3 + 1];
                const z = positions_array[i3 + 2];
                
                // 目标位置（爆炸效果）
                const targetX = x * (Math.random() * 15 + 5);
                const targetY = y * (Math.random() * 15 + 5);
                const targetZ = z * (Math.random() * 15 + 5);
                
                // 使用GSAP动画
                gsap.to(positions_array, {
                    [i3]: targetX,
                    [i3 + 1]: targetY,
                    [i3 + 2]: targetZ,
                    duration: 2 + Math.random() * 1,
                    ease: "power3.out",
                    onUpdate: () => {
                        particlesGeometry.attributes.position.needsUpdate = true;
                    }
                });
            }
            
            // 粒子消失动画
            gsap.to(particlesMaterial, {
                opacity: 0,
                duration: 3,
                delay: 2,
                ease: "power2.in"
            });
        }
        
        // 生成签条
        function generateFortune(wishText, advice, affirmation, poetry) {
            // 根据输入的咒语生成签的类型
            const fortuneTypes = ['大吉', '中吉', '小吉', '末吉', '凶'];
            const fortuneTypesEnglish = ['Great Blessing', 'Middle Blessing', 'Small Blessing', 'Future Blessing', 'Bad Luck'];
            
            // 使用咒语的字符生成一个确定的签类型（伪随机，但对同一个咒语总是返回相同结果）
            let seed = 0;
            for (let i = 0; i < wishText.length; i++) {
                seed += wishText.charCodeAt(i);
            }
            
            const fortuneIndex = seed % fortuneTypes.length;
            const fortuneType = fortuneTypes[fortuneIndex];
            const fortuneTypeEnglish = fortuneTypesEnglish[fortuneIndex];
            
            // 创建签条DOM元素
            const resultArea = document.getElementById('result-area');
            resultArea.innerHTML = ''; // 清空之前的内容
            
            const fortuneElement = document.createElement('div');
            fortuneElement.className = 'fortune-slip';
            
            // 添加签条样式
            fortuneElement.style.position = 'absolute';
            fortuneElement.style.left = '50%';
            fortuneElement.style.top = '50%';
            fortuneElement.style.transform = 'translate(-50%, -50%)';
            fortuneElement.style.width = '80%';
            fortuneElement.style.maxWidth = '500px';
            fortuneElement.style.padding = '40px 30px';
            fortuneElement.style.backgroundColor = 'rgba(18, 16, 22, 0.8)';
            fortuneElement.style.backdropFilter = 'blur(10px)';
            fortuneElement.style.borderRadius = '8px';
            fortuneElement.style.boxShadow = '0 0 30px rgba(148, 0, 255, 0.3)';
            fortuneElement.style.color = '#fff';
            fortuneElement.style.textAlign = 'center';
            fortuneElement.style.opacity = '0';
            fortuneElement.style.transform = 'translate(-50%, -50%) scale(0.9)';
            
            // 签条内容
            fortuneElement.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 5px; font-weight: 300; text-shadow: 0 0 15px rgba(148, 0, 255, 0.8), 0 0 30px rgba(0, 183, 255, 0.6);">${fortuneType}</div>
                <div style="font-size: 1.2rem; margin-bottom: 20px; color: rgba(255, 255, 255, 0.7);">${fortuneTypeEnglish}</div>
                <div style="margin: 30px 0; padding: 20px 0; border-top: 1px solid rgba(255, 255, 255, 0.2); border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
                    <div style="font-size: 1.2rem; margin-bottom: 15px; color: rgba(255, 255, 255, 0.9);">${advice}</div>
                    <div style="font-size: 1.1rem; margin-top: 15px; color: rgba(255, 255, 255, 0.7);">${affirmation}</div>
                </div>
                <div style="font-style: italic; font-size: 1rem; margin-top: 20px; color: rgba(255, 255, 255, 0.6);">${poetry}</div>
            `;
            
            resultArea.appendChild(fortuneElement);
            
            // 保存结果到本地存储
            saveFortuneToDB(wishText, fortuneType, fortuneTypeEnglish, advice, affirmation, poetry);
            
            // 显示结果
            setTimeout(() => {
                // 隐藏加载动画
                document.getElementById('loading').style.display = 'none';
                
                // 显示结果区域
                resultArea.style.display = 'block';
                
                // 播放结果音效
                playResultSound(fortuneType);
                
                // 显示签条动画
                gsap.to(fortuneElement, {
                    opacity: 1,
                    scale: 1,
                    duration: 1.5,
                    ease: "elastic.out(1, 0.5)"
                });
            }, 3000); // 等待粒子动画完成
        }
        
        // 保存签条到本地存储
        function saveFortuneToDB(wish, type, typeEnglish, advice, affirmation, poetry) {
            const fortune = {
                id: Date.now(),
                date: new Date().toISOString(),
                wish,
                type,
                typeEnglish,
                advice,
                affirmation,
                poetry
            };
            
            // 获取现有历史记录
            let history = JSON.parse(localStorage.getItem('fortune-history') || '[]');
            
            // 添加新记录
            history.unshift(fortune);
            
            // 限制历史记录数量
            if (history.length > 20) {
                history = history.slice(0, 20);
            }
            
            // 保存回本地存储
            localStorage.setItem('fortune-history', JSON.stringify(history));
        }
        
        // 重置场景
        function resetScene() {
            console.log("Drawing again...");
            
            // 隐藏结果区域
            document.getElementById('result-area').style.display = 'none';
            
            // 显示输入区域
            document.getElementById('input-area').style.display = 'block';
            
            // 清空输入框
            document.getElementById('wish-input').value = '';
            document.getElementById('wish-input').focus();
            
            // 移除粒子系统
            if (particleSystem) {
                scene.remove(particleSystem);
                particleSystem.geometry.dispose();
                particleSystem.material.dispose();
                particleSystem = null;
            }
            
            // 恢复墨迹显示
            if (inkBlob) {
                gsap.to(inkBlob.material, {
                    opacity: 1,
                    duration: 1,
                    ease: "power2.inOut"
                });
            }
            
            isDrawing = false;
        }
        
        // 保存签条为图片
        function saveFortune() {
            console.log("Saving divination...");
            
            // 确保html2canvas已加载
            if (!window.html2canvas) {
                alert('Image capture tool is loading, please try again in a few seconds.');
                loadHtml2Canvas();
                setTimeout(() => {
                    saveFortune();
                }, 2000);
                return;
            }
            
            html2canvas(document.querySelector('.fortune-slip')).then(canvas => {
                // 创建下载链接
                const link = document.createElement('a');
                link.download = `NeonOmikuji-${new Date().toLocaleDateString()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                console.error('Save failed:', err);
                alert('Save failed. Please try again.');
            });
        }
        
        // 显示历史记录
        function toggleHistory() {
            console.log("Displaying history...");
            
            // 创建历史记录面板
            let historyPanel = document.getElementById('history-panel-container');
            
            if (!historyPanel) {
                historyPanel = document.createElement('div');
                historyPanel.id = 'history-panel-container';
                historyPanel.style.position = 'fixed';
                historyPanel.style.left = '0';
                historyPanel.style.top = '0';
                historyPanel.style.width = '100%';
                historyPanel.style.height = '100%';
                historyPanel.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
                historyPanel.style.backdropFilter = 'blur(10px)';
                historyPanel.style.zIndex = '1000';
                historyPanel.style.display = 'flex';
                historyPanel.style.justifyContent = 'center';
                historyPanel.style.alignItems = 'center';
                historyPanel.style.opacity = '0';
                historyPanel.style.transition = 'opacity 0.3s ease';
                
                const historyContent = document.createElement('div');
                historyContent.style.width = '80%';
                historyContent.style.maxWidth = '800px';
                historyContent.style.maxHeight = '80vh';
                historyContent.style.overflowY = 'auto';
                historyContent.style.padding = '30px';
                
                // 添加关闭按钮
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '×';
                closeBtn.style.position = 'absolute';
                closeBtn.style.top = '20px';
                closeBtn.style.right = '20px';
                closeBtn.style.background = 'none';
                closeBtn.style.border = 'none';
                closeBtn.style.color = '#fff';
                closeBtn.style.fontSize = '2rem';
                closeBtn.style.cursor = 'pointer';
                closeBtn.onclick = () => {
                    historyPanel.style.opacity = '0';
                    setTimeout(() => {
                        historyPanel.style.display = 'none';
                    }, 300);
                };
                
                historyPanel.appendChild(closeBtn);
                historyPanel.appendChild(historyContent);
                document.body.appendChild(historyPanel);
            }
            
            // 显示面板
            historyPanel.style.display = 'flex';
            setTimeout(() => {
                historyPanel.style.opacity = '1';
            }, 10);
            
            // 获取历史记录
            const history = JSON.parse(localStorage.getItem('fortune-history') || '[]');
            const historyContent = historyPanel.querySelector('div');
            
            // 清空之前的内容
            historyContent.innerHTML = '<h2 style="text-align: center; margin-bottom: 30px; font-size: 2rem; font-weight: 300; color: #fff;">History</h2>';
            
            if (history.length === 0) {
                historyContent.innerHTML += '<p style="text-align: center; color: rgba(255, 255, 255, 0.6);">No history records</p>';
                return;
            }
            
            // 添加历史记录
            history.forEach(item => {
                const date = new Date(item.date).toLocaleString();
                
                const historyItem = document.createElement('div');
                historyItem.style.marginBottom = '20px';
                historyItem.style.padding = '20px';
                historyItem.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                historyItem.style.borderRadius = '8px';
                historyItem.style.cursor = 'pointer';
                historyItem.style.transition = 'all 0.3s ease';
                
                historyItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-size: 1.5rem; color: #fff;">${item.type}</span>
                        <span style="color: rgba(255, 255, 255, 0.6);">${date}</span>
                    </div>
                    <div style="color: rgba(255, 255, 255, 0.8); margin-bottom: 5px;">Spell: ${item.wish}</div>
                `;
                
                // 点击查看详情
                historyItem.onclick = () => {
                    showHistoryDetail(item);
                };
                
                // 鼠标悬停效果
                historyItem.onmouseover = () => {
                    historyItem.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                };
                
                historyItem.onmouseout = () => {
                    historyItem.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                };
                
                historyContent.appendChild(historyItem);
            });
        }
        
        // 显示历史记录详情
        function showHistoryDetail(item) {
            // 创建详情面板
            let detailPanel = document.getElementById('detail-panel');
            
            if (!detailPanel) {
                detailPanel = document.createElement('div');
                detailPanel.id = 'detail-panel';
                detailPanel.style.position = 'fixed';
                detailPanel.style.left = '0';
                detailPanel.style.top = '0';
                detailPanel.style.width = '100%';
                detailPanel.style.height = '100%';
                detailPanel.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
                detailPanel.style.backdropFilter = 'blur(15px)';
                detailPanel.style.zIndex = '1100';
                detailPanel.style.display = 'flex';
                detailPanel.style.justifyContent = 'center';
                detailPanel.style.alignItems = 'center';
                detailPanel.style.opacity = '0';
                detailPanel.style.transition = 'opacity 0.3s ease';
                
                document.body.appendChild(detailPanel);
            }
            
            // 显示面板
            detailPanel.style.display = 'flex';
            setTimeout(() => {
                detailPanel.style.opacity = '1';
            }, 10);
            
            // 设置详情内容
            detailPanel.innerHTML = `
                <div style="position: relative; width: 80%; max-width: 600px; padding: 40px; background-color: rgba(18, 16, 22, 0.8); border-radius: 8px; box-shadow: 0 0 30px rgba(148, 0, 255, 0.3);">
                    <button style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #fff; font-size: 2rem; cursor: pointer;" onclick="document.getElementById('detail-panel').style.display = 'none';">×</button>
                    <div style="font-size: 3rem; margin-bottom: 5px; font-weight: 300; text-align: center; text-shadow: 0 0 15px rgba(148, 0, 255, 0.8), 0 0 30px rgba(0, 183, 255, 0.6);">${item.type}</div>
                    <div style="font-size: 1.2rem; margin-bottom: 20px; text-align: center; color: rgba(255, 255, 255, 0.7);">${item.typeEnglish || ''}</div>
                    <div style="text-align: center; margin-bottom: 20px; color: rgba(255, 255, 255, 0.7);">Spell: ${item.wish}</div>
                    <div style="margin: 30px 0; padding: 20px 0; border-top: 1px solid rgba(255, 255, 255, 0.2); border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
                        <div style="font-size: 1.2rem; margin-bottom: 15px; color: rgba(255, 255, 255, 0.9);">${item.advice}</div>
                        <div style="font-size: 1.1rem; margin-top: 15px; color: rgba(255, 255, 255, 0.7);">${item.affirmation}</div>
                    </div>
                    <div style="font-style: italic; font-size: 1rem; margin-top: 20px; color: rgba(255, 255, 255, 0.6); text-align: center;">${item.poetry}</div>
                    <div style="text-align: right; margin-top: 20px; color: rgba(255, 255, 255, 0.5); font-size: 0.9rem;">${new Date(item.date).toLocaleString()}</div>
                </div>
            `;
        }
        
        // API调用函数
        async function fetchAdvice() {
            try {
                const response = await fetch('https://api.adviceslip.com/advice');
                const data = await response.json();
                return data.slip.advice;
            } catch (error) {
                console.error('Failed to fetch advice:', error);
                return 'Follow the guidance of your heart, and you will find the true direction.';
            }
        }
        
        async function fetchAffirmation() {
            try {
                const response = await fetch('https://www.affirmations.dev/');
                const data = await response.json();
                return data.affirmation;
            } catch (error) {
                console.error('Failed to fetch affirmation:', error);
                return 'You have infinite potential, believe in yourself to create miracles.';
            }
        }
        
        async function fetchPoetry() {
            try {
                const response = await fetch('https://poetrydb.org/random');
                const data = await response.json();
                const poem = data[0];
                
                // 只取诗歌的前两行
                const lines = poem.lines.slice(0, 2).join(' / ');
                return `${lines} - ${poem.author}`;
            } catch (error) {
                console.error('Failed to fetch poetry:', error);
                return 'Hope is the thing with feathers - That perches in the soul - Emily Dickinson';
            }
        }
        
        // 音效功能
        function playStartSound() {
            // 创建Tone.js合成器
            const synth = new Tone.PolySynth(Tone.Synth).toDestination();
            
            // 设置音量
            synth.volume.value = -10;
            
            // 创建音序
            const now = Tone.now();
            synth.triggerAttackRelease("C4", "8n", now);
            synth.triggerAttackRelease("E4", "8n", now + 0.1);
            synth.triggerAttackRelease("G4", "8n", now + 0.2);
            synth.triggerAttackRelease("C5", "4n", now + 0.3);
        }
        
        function playResultSound(fortuneType) {
            // 根据签类型播放不同音效
            const synth = new Tone.PolySynth(Tone.Synth).toDestination();
            synth.volume.value = -10;
            
            const now = Tone.now();
            
            if (fortuneType === '大吉') {
                // 欢快的音效
                synth.triggerAttackRelease("C5", "8n", now);
                synth.triggerAttackRelease("E5", "8n", now + 0.1);
                synth.triggerAttackRelease("G5", "8n", now + 0.2);
                synth.triggerAttackRelease("C6", "4n", now + 0.3);
            } else if (fortuneType === '凶') {
                // 低沉的音效
                synth.triggerAttackRelease("D3", "8n", now);
                synth.triggerAttackRelease("F3", "8n", now + 0.2);
                synth.triggerAttackRelease("A3", "4n", now + 0.4);
            } else {
                // 中性音效
                synth.triggerAttackRelease("E4", "8n", now);
                synth.triggerAttackRelease("G4", "8n", now + 0.15);
                synth.triggerAttackRelease("B4", "4n", now + 0.3);
            }
        }
        
        // 添加html2canvas库用于保存签条图片
        function loadHtml2Canvas() {
            if (!window.html2canvas) {
                const script = document.createElement('script');
                script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                document.head.appendChild(script);
            }
        }
        
        function updateParticles() {
            // 更新粒子系统
            if (particleSystem && particleSystem.geometry) {
                // 粒子旋转效果
                particleSystem.rotation.y += 0.001;
                particleSystem.rotation.x += 0.0005;
                
                // 更新粒子位置
                const positions = particleSystem.geometry.attributes.position.array;
                const count = positions.length / 3;
                
                for (let i = 0; i < count; i++) {
                    const i3 = i * 3;
                    const x = positions[i3];
                    const y = positions[i3 + 1];
                    const z = positions[i3 + 2];
                    
                    // 添加轻微的波动效果
                    const time = Date.now() * 0.0001;
                    const wobble = Math.sin(time + i) * 0.01;
                    
                    positions[i3] = x + wobble;
                    positions[i3 + 1] = y + wobble;
                    positions[i3 + 2] = z + wobble;
                }
                
                particleSystem.geometry.attributes.position.needsUpdate = true;
            }
        }
    </script>
    <!-- 添加API信息说明 -->
    <div style="position: fixed; bottom: 10px; left: 0; width: 100%; text-align: center; font-size: 0.7rem; color: rgba(255, 255, 255, 0.3); z-index: 50;">
        Using: Advice Slip API, Affirmations API, PoetryDB API | Neon Omikuji v1.0
    </div>
</body>
</html> 